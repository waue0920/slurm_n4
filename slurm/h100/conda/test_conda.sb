#!/bin/bash
#SBATCH --job-name=TestTorchrun    ## Job 名稱
#SBATCH --mail-type=ALL            ## 收到通知條件
#SBATCH --mail-user=waue0920@gmail.com
#SBATCH --nodes=1                  ## 索取 x 個節點
#SBATCH --cpus-per-task=8          ## 每個 task 索取 x 顆 CPU
#SBATCH --gres=gpu:2               ## 每個節點索取 x 張 GPU
#SBATCH --account="GOV113054"      ## iService_ID 計畫 ID
#SBATCH --partition=dev          ## 使用測試 queue
#SBATCH --output=slurm-conda.log  ## 將標準輸出記錄到 log
#SBATCH --error=slurm-conda.log   ## 將錯誤輸出記錄到同一個 log


# needed in H100
module purge
module load singularity

# sif
SIF=/home/waue0920/sif/yolov9-ngc2111-def-20241115.sif
SINGULARITY="singularity run --nv $SIF"


# 設定環境
CONDA_PATH="/home/waue0920/miniconda3/bin/activate"
CONDA_ENV="yolo9t2"

# 進入工作目錄
WORKDIR=/home/waue0920/yolov9  # 替換為你的工作目錄
cd $WORKDIR

# 確保分配節點後的網路資訊
MASTER_ADDR=$(scontrol show hostname $SLURM_NODELIST | head -n 1)
export MASTER_ADDR

echo "Job started on $(hostname)"
echo "MASTER_ADDR=$MASTER_ADDR"

# 啟動 Singularity 容器
singularity exec --nv $SIF_PATH bash -c "
    # 啟用 Conda 環境
    source $CONDA_PATH $CONDA_ENV

    # 登入 wandb
    wandb login

    # 確保進入後可持續互動，視需要加入其他指令
    echo 'Environment is ready. Use wandb and other tools within the container.'
"

echo "Job completed!"
