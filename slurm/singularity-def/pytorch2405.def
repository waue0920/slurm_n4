Bootstrap: docker
From: nvcr.io/nvidia/pytorch:24.05-py3

%post
    # 更新系統並安裝必要的依賴項
    apt-get update && apt-get install -y \
        wget \
        git \
        vim \
        build-essential \
        libssl-dev \
        libffi-dev

    python3 -m pip install --upgrade pip
    pip install nemo_toolkit[all]

    apt-get clean
    rm -rf /var/lib/apt/lists/*

%environment
    if [ -d "/usr/local/cuda-12.4/bin" ]; then
        export PATH=/usr/local/cuda-12.4/bin:$PATH
        export LD_LIBRARY_PATH=/usr/local/cuda-12.4/lib64:$LD_LIBRARY_PATH
    elif [ -d "/usr/local/cuda/bin" ]; then
        export PATH=/usr/local/cuda/bin:$PATH
        export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH
    fi

    # Python 路徑設置
    export PYTHONPATH=/opt/conda/lib/python3.10/site-packages:$PYTHONPATH

%labels
    Maintainer "wychen <wychen@narlabs.org.tw>"
    Version "1.0"

%runscript
    echo "This container provides PyTorch with CUDA 12.4 and NVIDIA NeMo support"
    exec "$@"
